<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:aop="http://www.springframework.org/schema/aop" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd">

    <!-- JCR -->

    <bean id="jcrRepositoryConfig" class="org.apache.jackrabbit.core.config.RepositoryConfig" factory-method="install">
        <constructor-arg>
            <bean class="java.io.File">
                <constructor-arg value="${jcr.repository.config.file}" />
            </bean>
        </constructor-arg>
        <constructor-arg>
            <bean class="java.io.File">
                <constructor-arg value="${jcr.repository.dir}" />
            </bean>
        </constructor-arg>
    </bean>

    <bean id="jcrRepository" class="org.apache.jackrabbit.core.RepositoryImpl" factory-method="create" destroy-method="shutdown">
        <constructor-arg ref="jcrRepositoryConfig" />
    </bean>

    <bean id="jcrPassword" class="java.lang.String">
        <constructor-arg value="${jcr.user.password}" />
    </bean>

    <bean id="jcrCredentials" class="javax.jcr.SimpleCredentials">
        <constructor-arg value="${jcr.user.name}" />
        <constructor-arg>
            <bean factory-bean="jcrPassword" factory-method="toCharArray" />
        </constructor-arg>
    </bean>
    
    <bean id="jcrSessionManager" class="org.cee.news.store.jcr.ThreadLocalSessionManager" destroy-method="closeSessions">
       <property name="repository" ref="jcrRepository" />
       <property name="credentials" ref="jcrCredentials" />
    </bean>

    <bean id="jcrSession" factory-bean="jcrRepository" factory-method="login" scope="prototype" destroy-method="logout">
        <constructor-arg ref="jcrCredentials" />
    </bean>
    
    <bean class="org.cee.news.store.jcr.JcrStoreInitializer" init-method="registerNodeTypes">
        <property name="session">
            <bean factory-bean="jcrRepository" factory-method="login">
                <constructor-arg ref="jcrCredentials" />
            </bean>
        </property>
    </bean>

    <!-- Backend Services -->
    
    <bean id="siteStore" class="org.cee.news.store.jcr.JcrSiteStore">
        <property name="sessionManager" ref="jcrSessionManager" />
    </bean>

    <bean id="articleStore" class="org.cee.news.store.jcr.JcrArticleStore">
        <property name="sessionManager" ref="jcrSessionManager" />
    </bean>
    
    <bean id="articleSearchService" class="org.cee.news.store.jcr.JcrArticleSearchService">
        <property name="sessionManager" ref="jcrSessionManager" />
    </bean>

    <bean id="workingSetStore" class="org.cee.news.store.jcr.JcrWorkingSetStore">
        <property name="sessionManager" ref="jcrSessionManager" />
    </bean>
    
</beans>